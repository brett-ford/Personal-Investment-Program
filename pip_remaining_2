-- Value remaining to be invested via personal investment plans

-- pip_invested = total amount already invesed, per pip, via a pip.
-- pip_value = total value of a pip plan, both already invested and funds to be invested 
-- pip_remaining = the total amount remaining to be invested per pip plan 

-- Edge case: customer sets up two pips with same frequency and amount, one on 7th and one on 21st 


WITH pip_table_1
AS (
  SELECT *
  FROM pip
  WHERE datediff(dd, GETDATE(), begin) >= 0 and datediff(dd, end, GETDATE()) >= 0 
  ),
  
pip_table_2
AS (
  SELECT 
    *,
    
    CASE 
      WHEN DATEPART(day, begin) < day AND DATEPART(day, GETDATE()) < day
      THEN CASE 
             WHEN frequency = "monthly" THEN (DATEDIFF(mm, GETDATE(), begin) - 1) * amount
             WHEN frequency = "quarterly" THEN (((DATEDIFF(mm, GETDATE(), begin) - 1)/3) + 1) * amount
             WHEN frequency = "semiannually" THEN (((DATEDIFF(mm, GETDATE(), begin) - 1)/6) + 1) * amount
           END
      WHEN (DATEPART(day, begin) < day AND DATEPART(day, GETDATE()) > day) OR (DATEPART(day, begin) > day AND DATEPART(day, GETDATE()) < day)
      THEN CASE 
             WHEN frequency = "monthly" THEN (DATEDIFF(mm, GETDATE(), begin) + 0) * amount
             WHEN frequency = "quarterly" THEN (((DATEDIFF(mm, GETDATE(), begin) + 0)/3) + 1) * amount
             WHEN frequency = "semiannually" THEN (((DATEDIFF(mm, GETDATE(), begin) + 0)/6) + 1) * amount
           END
      WHEN DATEPART(day, begin) > day AND DATEPART(day, GETDATE()) > day
      THEN CASE 
             WHEN frequency = "monthly" THEN (DATEDIFF(mm, GETDATE(), begin) + 1) * amount
             WHEN frequency = "quarterly" THEN (((DATEDIFF(mm, GETDATE(), begin) + 1)/3) + 1) * amount
             WHEN frequency = "semiannually" THEN (((DATEDIFF(mm, GETDATE(), begin) + 1)/6) + 1) * amount
           END  
    END AS pip_invested,    
    
    CASE 
      WHEN frequency = "monthly" THEN (datediff(mm, end, begin) + 1) * amount
      WHEN frequency = "quarterly" THEN (((datediff(mm, end, begin) + 1)/3) + 1) * amount
      WHEN frequency = "semiannually" THEN (((datediff(mm, end, begin) + 1)/6) + 1) * amount
    END AS pip_total
  FROM pip_table_1
  )
  
SELECT 
  *,
  pip_total - pip_invested AS pip_remaining
FROM pip_table_2
  
