-- Value remaining to be invested via personal investment plans
-- accounts for the month in which the report is being run. 
-- does not account for the minute the report is being run. 
-- does not handle pips that are set up but haven't had their first investment. 
-- this will be accurate on the 7th and 21st, after close of business, and any time on any other day. 
-- assumes that account_id, amount, and frequency form a compound primary key for the pip table. 

-- pip_invested = total amount already invesed per pip 
-- pip_value = total value of a pip plan, past and future investments 
-- pip_remaining = the total amount remaining to be invested per pip plan 

-- Edge case: customer sets up two pips with same frequency and amount, one on 7th and one on 21st 


WITH pip_table_1
AS (
  SELECT *
  FROM pip
  WHERE datediff(dd, begin, GETDATE()) >= 0 AND datediff(dd, GETDATE(), end) >= 0 
  ),
  
pip_table_2
AS (
  SELECT 
    *,
    
    CASE 
      WHEN frequency = "monthly"
      THEN CASE 
             WHEN DATEPART(day, GETDATE()) >= day
             THEN (DATEDIFF(mm, begin, GETDATE()) + 1) * amount
             ELSE DATEDIFF(mm, begin, GETDATE()) * amount
           END  
           
      WHEN frequency = "quarterly"
      THEN CASE 
             WHEN DATEPART(day, GETDATE()) >= day
             THEN ((DATEDIFF(mm, begin, GETDATE())/3) + 1) * amount
             ELSE (((DATEDIFF(mm, begin, GETDATE())-1)/3) + 1) * amount
           END
           
      WHEN frequency = "semiannually"
      THEN CASE 
             WHEN DATEPART(day, GETDATE()) >= day
             THEN ((DATEDIFF(mm, begin, GETDATE())/6) + 1) * amount
             ELSE (((DATEDIFF(mm, begin, GETDATE())-1)/6) + 1) * amount
           END  
    END AS pip_invested,  
      
    CASE 
      WHEN frequency = "monthly" 
      THEN (datediff(mm, begin, end) + 1) * amount
      
      WHEN frequency = "quarterly" 
      THEN (((datediff(mm, begin, end) + 1)/3) + 1) * amount
      
      WHEN frequency = "semiannually" 
      THEN (((datediff(mm, begin, end) + 1)/6) + 1) * amount
    END AS pip_total
  
  FROM pip_table_1
  )
  
SELECT 
  *,
  pip_total - pip_invested AS pip_remaining
FROM pip_table_2
  
